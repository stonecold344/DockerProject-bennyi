version: '3.8'

services:
  mongo1:
    image: mongo:latest
    container_name: mongo1
    restart: always
    ports:
      - "27017:27017"
    volumes:
      - mongo1-data:/data/db
    command: ["mongod", "--replSet", "rs0"]
    networks:
      - mongo-cluster

  mongo2:
    image: mongo:latest
    container_name: mongo2
    restart: always
    ports:
      - "27018:27017"
    volumes:
      - mongo2-data:/data/db
    command: ["mongod", "--replSet", "rs0"]
    networks:
      - mongo-cluster

  mongo3:
    image: mongo:latest
    container_name: mongo3
    restart: always
    ports:
      - "27019:27017"
    volumes:
      - mongo3-data:/data/db
    command: ["mongod", "--replSet", "rs0"]
    networks:
      - mongo-cluster

  mongo-init-replica:
    image: mongo:latest
    depends_on:
      - mongo1
      - mongo2
      - mongo3
    networks:
      - mongo-cluster
    entrypoint: ["sh", "-c", "sleep 10 && mongosh --host mongo1:27017 --eval 'rs.initiate({_id:\"rs0\", members:[{_id:0, host:\"mongo1:27017\"}, {_id:1, host:\"mongo2:27018\"}, {_id:2, host:\"mongo3:27019\"}]});'"]


  yolo5:
    build: ./yolo5
    image: ${YOLO5_IMG_NAME}
    ports:
      - "8081:8081"
    volumes:
      - ~/.aws:/root/.aws
      - ~/projects/DockerProject-bennyi/static/data:/usr/src/app/static/data
    environment:
      - MONGO_URI=mongodb://mongo1:27017,mongo2:27018,mongo3:27019/?replicaSet=rs0
    networks:
      - mongo-cluster

  polybot:
    build: ./polybot
    image: ${POLYBOT_IMG_NAME}
    environment:
      TELEGRAM_TOKEN: ${TELEGRAM_TOKEN}
      TELEGRAM_APP_URL: ${TELEGRAM_APP_URL}
      S3_BUCKET_NAME: ${S3_BUCKET_NAME}
      YOLO5_URL: ${YOLO5_URL}
    ports:
      - "8443:8443"
    networks:
      - mongo-cluster

volumes:
  mongo1-data:
  mongo2-data:
  mongo3-data:

networks:
  mongo-cluster:
